<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geocode Travel Destinations - Admin Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .description {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    button {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #7c3aed;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .log {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.8;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #f59e0b; }
    .info { color: #3b82f6; }
    
    .summary {
      margin-top: 20px;
      padding: 15px;
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      border-radius: 4px;
    }
    
    .summary h3 {
      margin: 0 0 10px 0;
      color: #1e40af;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üåç Geocode Travel Destinations</h1>
    <p class="description">
      This tool will geocode favorite travel cities for all party profiles that don't have coordinates yet.
      It uses OpenStreetMap's Nominatim service and respects their rate limit (1 request per second).
    </p>
    
    <button id="startBtn" onclick="startGeocoding()">Start Geocoding</button>
    
    <div id="log" class="log" style="display: none;"></div>
    <div id="summary" style="display: none;"></div>
  </div>
  
  <script type="module">
    // Import Supabase client from config
    import { supabase } from './config/env.local.js';
    
    window.supabase = supabase;
    
    // Geocode a city name using Nominatim
    async function geocodeCity(cityName) {
      if (!cityName || !cityName.trim()) return null;
      
      try {
        const url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({
          q: cityName,
          format: 'json',
          limit: '1'
        });
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'PartyApp/1.0'
          }
        });
        
        if (!response.ok) {
          console.error('[geocodeCity] HTTP error:', response.status);
          return null;
        }
        
        const data = await response.json();
        if (data && data.length > 0) {
          return {
            lat: parseFloat(data[0].lat),
            lng: parseFloat(data[0].lon),
            display_name: data[0].display_name
          };
        }
        
        return null;
      } catch (error) {
        console.error('[geocodeCity] Error:', error);
        return null;
      }
    }
    
    // Sleep utility
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Log to UI
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      logDiv.style.display = 'block';
      
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = message;
      logDiv.appendChild(entry);
      
      // Scroll to bottom
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    // Main geocoding function
    window.startGeocoding = async function() {
      const btn = document.getElementById('startBtn');
      const logDiv = document.getElementById('log');
      const summaryDiv = document.getElementById('summary');
      
      btn.disabled = true;
      logDiv.innerHTML = '';
      summaryDiv.style.display = 'none';
      
      log('üåç Starting travel destination geocoding...', 'info');
      log('', 'info');
      
      try {
        // Fetch profiles that need geocoding
        const { data: profiles, error } = await supabase
          .from('party_profiles')
          .select('user_id, party_id, display_name, extended_answers')
          .is('fav_dest_lat', null);
        
        if (error) {
          log(`‚ùå Error fetching profiles: ${error.message}`, 'error');
          btn.disabled = false;
          return;
        }
        
        log(`üìä Found ${profiles.length} profiles to process`, 'info');
        log('', 'info');
        
        let processed = 0;
        let geocoded = 0;
        let skipped = 0;
        let failed = 0;
        
        for (const profile of profiles) {
          const travelCity = profile.extended_answers?.fav_city_travel;
          
          if (!travelCity || !travelCity.trim()) {
            log(`‚è≠Ô∏è  Skipping ${profile.display_name} - no travel city`, 'warning');
            skipped++;
            processed++;
            continue;
          }
          
          log(`üîç Geocoding "${travelCity}" for ${profile.display_name}...`, 'info');
          
          // Geocode the city
          const geoResult = await geocodeCity(travelCity);
          
          if (geoResult) {
            // Update the profile
            const { error: updateError } = await supabase
              .from('party_profiles')
              .update({
                fav_dest_city: travelCity,
                fav_dest_lat: geoResult.lat,
                fav_dest_lng: geoResult.lng
              })
              .eq('user_id', profile.user_id)
              .eq('party_id', profile.party_id);
            
            if (updateError) {
              log(`   ‚ùå Failed to update: ${updateError.message}`, 'error');
              failed++;
            } else {
              log(`   ‚úÖ ${geoResult.display_name}`, 'success');
              log(`   üìç ${geoResult.lat}, ${geoResult.lng}`, 'success');
              geocoded++;
            }
          } else {
            log(`   ‚ö†Ô∏è  Could not geocode "${travelCity}"`, 'warning');
            failed++;
          }
          
          processed++;
          
          // Respect Nominatim rate limit
          if (processed < profiles.length) {
            log('   ‚è≥ Waiting 1 second (rate limit)...', 'info');
            log('', 'info');
            await sleep(1000);
          }
        }
        
        // Show summary
        log('', 'info');
        log('‚ú® Geocoding complete!', 'success');
        
        summaryDiv.innerHTML = `
          <div class="summary">
            <h3>üìä Summary</h3>
            <div>Total profiles: ${profiles.length}</div>
            <div>Successfully geocoded: <span class="success">${geocoded}</span></div>
            <div>Skipped (no city): <span class="warning">${skipped}</span></div>
            <div>Failed: <span class="error">${failed}</span></div>
          </div>
        `;
        summaryDiv.style.display = 'block';
        
      } catch (error) {
        log(`‚ùå Unexpected error: ${error.message}`, 'error');
        console.error(error);
      }
      
      btn.disabled = false;
    };
  </script>
</body>
</html>
