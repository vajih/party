<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleanup Orphaned Data - Admin Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
    }
    
    .warning strong {
      color: #92400e;
    }
    
    .description {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    
    button {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    button:hover:not(:disabled) {
      background: #7c3aed;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    button.danger {
      background: #ef4444;
    }
    
    button.danger:hover:not(:disabled) {
      background: #dc2626;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #8b5cf6;
    }
    
    .stat-card.orphaned {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }
    
    .orphaned-list {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .orphaned-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #ef4444;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
    }
    
    .log {
      margin-top: 20px;
      padding: 15px;
      background: #1f2937;
      color: #f9fafb;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.8;
      display: none;
    }
    
    .log-entry {
      margin: 3px 0;
    }
    
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning-text { color: #f59e0b; }
    .info { color: #60a5fa; }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üßπ Cleanup Orphaned Data</h1>
    <p class="description">
      This tool finds and removes data from users who have been deleted from Supabase Auth
      but still have data in your database tables (votes, submissions, profiles, etc.).
    </p>
    
    <div class="warning">
      <strong>‚ö†Ô∏è Important:</strong> This tool will permanently delete orphaned data. 
      Review the statistics carefully before proceeding with cleanup.
    </div>
    
    <div class="button-group">
      <button id="scanBtn" onclick="scanOrphanedData()">
        üîç Scan for Orphaned Data
      </button>
      <button id="cleanupBtn" onclick="cleanupOrphanedData()" class="danger" disabled>
        üóëÔ∏è Delete Orphaned Data
      </button>
    </div>
    
    <div id="stats" class="stats hidden"></div>
    <div id="orphanedList" class="orphaned-list hidden"></div>
    <div id="log" class="log"></div>
  </div>
  
  <script type="module">
    // Import supabase from the correct location
    import { supabase } from '../src/services/supabaseClient.js';
    
    window.supabase = supabase;
    window.orphanedData = null;
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      logDiv.style.display = 'block';
      
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = message;
      logDiv.appendChild(entry);
      
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    window.scanOrphanedData = async function() {
      const scanBtn = document.getElementById('scanBtn');
      const cleanupBtn = document.getElementById('cleanupBtn');
      const statsDiv = document.getElementById('stats');
      const orphanedListDiv = document.getElementById('orphanedList');
      const logDiv = document.getElementById('log');
      
      scanBtn.disabled = true;
      cleanupBtn.disabled = true;
      statsDiv.classList.add('hidden');
      orphanedListDiv.classList.add('hidden');
      logDiv.innerHTML = '';
      logDiv.style.display = 'block';
      
      log('üîç Starting scan for orphaned data...', 'info');
      log('', 'info');
      
      try {
        // Get all valid user IDs from auth
        const { data: { users }, error: authError } = await supabase.auth.admin.listUsers();
        
        if (authError) {
          log(`‚ùå Error fetching auth users: ${authError.message}`, 'error');
          scanBtn.disabled = false;
          return;
        }
        
        const validUserIds = new Set(users.map(u => u.id));
        log(`‚úÖ Found ${validUserIds.size} valid users in auth`, 'success');
        log('', 'info');
        
        // Check each table for orphaned data
        const orphanedData = {
          votes: [],
          submissions: [],
          party_profiles: [],
          party_hosts: []
        };
        
        // Check votes
        log('üìä Checking votes table...', 'info');
        const { data: votes, error: votesError } = await supabase
          .from('votes')
          .select('user_id');
        
        if (votesError) {
          log(`‚ö†Ô∏è  Error checking votes: ${votesError.message}`, 'warning-text');
        } else {
          orphanedData.votes = votes
            .map(v => v.user_id)
            .filter(uid => !validUserIds.has(uid));
          const uniqueOrphaned = new Set(orphanedData.votes);
          log(`   Found ${votes.length} total votes`, 'info');
          log(`   Found ${orphanedData.votes.length} orphaned votes from ${uniqueOrphaned.size} deleted users`, 
              orphanedData.votes.length > 0 ? 'warning-text' : 'success');
        }
        log('', 'info');
        
        // Check submissions
        log('üìä Checking submissions table...', 'info');
        const { data: submissions, error: submissionsError } = await supabase
          .from('submissions')
          .select('user_id, display_name');
        
        if (submissionsError) {
          log(`‚ö†Ô∏è  Error checking submissions: ${submissionsError.message}`, 'warning-text');
        } else {
          orphanedData.submissions = submissions
            .filter(s => !validUserIds.has(s.user_id));
          log(`   Found ${submissions.length} total submissions`, 'info');
          log(`   Found ${orphanedData.submissions.length} orphaned submissions`, 
              orphanedData.submissions.length > 0 ? 'warning-text' : 'success');
        }
        log('', 'info');
        
        // Check party_profiles
        log('üìä Checking party_profiles table...', 'info');
        const { data: profiles, error: profilesError } = await supabase
          .from('party_profiles')
          .select('user_id, display_name');
        
        if (profilesError) {
          log(`‚ö†Ô∏è  Error checking party_profiles: ${profilesError.message}`, 'warning-text');
        } else {
          orphanedData.party_profiles = profiles
            .filter(p => !validUserIds.has(p.user_id));
          log(`   Found ${profiles.length} total profiles`, 'info');
          log(`   Found ${orphanedData.party_profiles.length} orphaned profiles`, 
              orphanedData.party_profiles.length > 0 ? 'warning-text' : 'success');
        }
        log('', 'info');
        
        // Check party_hosts
        log('üìä Checking party_hosts table...', 'info');
        const { data: hosts, error: hostsError } = await supabase
          .from('party_hosts')
          .select('user_id, invite_email')
          .not('user_id', 'is', null);
        
        if (hostsError) {
          log(`‚ö†Ô∏è  Error checking party_hosts: ${hostsError.message}`, 'warning-text');
        } else {
          orphanedData.party_hosts = hosts
            .filter(h => h.user_id && !validUserIds.has(h.user_id));
          log(`   Found ${hosts.length} total hosts with user_id`, 'info');
          log(`   Found ${orphanedData.party_hosts.length} orphaned host entries`, 
              orphanedData.party_hosts.length > 0 ? 'warning-text' : 'success');
        }
        log('', 'info');
        
        // Store for cleanup
        window.orphanedData = orphanedData;
        
        // Calculate totals
        const totalOrphaned = 
          orphanedData.votes.length +
          orphanedData.submissions.length +
          orphanedData.party_profiles.length +
          orphanedData.party_hosts.length;
        
        // Get unique orphaned user IDs
        const allOrphanedUserIds = new Set([
          ...orphanedData.votes,
          ...orphanedData.submissions.map(s => s.user_id),
          ...orphanedData.party_profiles.map(p => p.user_id),
          ...orphanedData.party_hosts.map(h => h.user_id)
        ]);
        
        log('‚ú® Scan complete!', 'success');
        log(`üìä Total orphaned records: ${totalOrphaned}`, totalOrphaned > 0 ? 'warning-text' : 'success');
        log(`üë• Deleted users with data: ${allOrphanedUserIds.size}`, 'info');
        
        // Display stats
        statsDiv.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Valid Users</div>
            <div class="stat-value">${validUserIds.size}</div>
          </div>
          <div class="stat-card orphaned">
            <div class="stat-label">Orphaned Votes</div>
            <div class="stat-value">${orphanedData.votes.length}</div>
          </div>
          <div class="stat-card orphaned">
            <div class="stat-label">Orphaned Submissions</div>
            <div class="stat-value">${orphanedData.submissions.length}</div>
          </div>
          <div class="stat-card orphaned">
            <div class="stat-label">Orphaned Profiles</div>
            <div class="stat-value">${orphanedData.party_profiles.length}</div>
          </div>
          <div class="stat-card orphaned">
            <div class="stat-label">Orphaned Hosts</div>
            <div class="stat-value">${orphanedData.party_hosts.length}</div>
          </div>
        `;
        statsDiv.classList.remove('hidden');
        
        // Display orphaned user list
        if (allOrphanedUserIds.size > 0) {
          orphanedListDiv.innerHTML = '<strong>Deleted User IDs with remaining data:</strong>';
          allOrphanedUserIds.forEach(uid => {
            const div = document.createElement('div');
            div.className = 'orphaned-item';
            div.textContent = uid;
            orphanedListDiv.appendChild(div);
          });
          orphanedListDiv.classList.remove('hidden');
          
          cleanupBtn.disabled = false;
        } else {
          log('', 'info');
          log('üéâ No orphaned data found! Database is clean.', 'success');
        }
        
      } catch (error) {
        log(`‚ùå Unexpected error: ${error.message}`, 'error');
        console.error(error);
      }
      
      scanBtn.disabled = false;
    };
    
    window.cleanupOrphanedData = async function() {
      if (!window.orphanedData) {
        alert('Please run a scan first!');
        return;
      }
      
      const totalOrphaned = 
        window.orphanedData.votes.length +
        window.orphanedData.submissions.length +
        window.orphanedData.party_profiles.length +
        window.orphanedData.party_hosts.length;
      
      if (totalOrphaned === 0) {
        alert('No orphaned data to clean up!');
        return;
      }
      
      const confirmed = confirm(
        `‚ö†Ô∏è WARNING: This will permanently delete ${totalOrphaned} orphaned records.\n\n` +
        `Are you sure you want to proceed?`
      );
      
      if (!confirmed) return;
      
      const cleanupBtn = document.getElementById('cleanupBtn');
      const scanBtn = document.getElementById('scanBtn');
      cleanupBtn.disabled = true;
      scanBtn.disabled = true;
      
      log('', 'info');
      log('üóëÔ∏è  Starting cleanup...', 'info');
      log('', 'info');
      
      try {
        let deleted = 0;
        
        // Get unique orphaned user IDs
        const orphanedUserIds = new Set([
          ...window.orphanedData.votes,
          ...window.orphanedData.submissions.map(s => s.user_id),
          ...window.orphanedData.party_profiles.map(p => p.user_id),
          ...window.orphanedData.party_hosts.map(h => h.user_id)
        ]);
        
        // Delete votes
        if (window.orphanedData.votes.length > 0) {
          log(`Deleting ${window.orphanedData.votes.length} orphaned votes...`, 'info');
          const { error } = await supabase
            .from('votes')
            .delete()
            .in('user_id', Array.from(orphanedUserIds));
          
          if (error) {
            log(`   ‚ùå Error: ${error.message}`, 'error');
          } else {
            log(`   ‚úÖ Deleted votes`, 'success');
            deleted += window.orphanedData.votes.length;
          }
        }
        
        // Delete submissions
        if (window.orphanedData.submissions.length > 0) {
          log(`Deleting ${window.orphanedData.submissions.length} orphaned submissions...`, 'info');
          const { error } = await supabase
            .from('submissions')
            .delete()
            .in('user_id', Array.from(orphanedUserIds));
          
          if (error) {
            log(`   ‚ùå Error: ${error.message}`, 'error');
          } else {
            log(`   ‚úÖ Deleted submissions`, 'success');
            deleted += window.orphanedData.submissions.length;
          }
        }
        
        // Delete party_profiles
        if (window.orphanedData.party_profiles.length > 0) {
          log(`Deleting ${window.orphanedData.party_profiles.length} orphaned profiles...`, 'info');
          const { error } = await supabase
            .from('party_profiles')
            .delete()
            .in('user_id', Array.from(orphanedUserIds));
          
          if (error) {
            log(`   ‚ùå Error: ${error.message}`, 'error');
          } else {
            log(`   ‚úÖ Deleted profiles`, 'success');
            deleted += window.orphanedData.party_profiles.length;
          }
        }
        
        // Delete party_hosts
        if (window.orphanedData.party_hosts.length > 0) {
          log(`Deleting ${window.orphanedData.party_hosts.length} orphaned host entries...`, 'info');
          const { error } = await supabase
            .from('party_hosts')
            .delete()
            .in('user_id', Array.from(orphanedUserIds));
          
          if (error) {
            log(`   ‚ùå Error: ${error.message}`, 'error');
          } else {
            log(`   ‚úÖ Deleted host entries`, 'success');
            deleted += window.orphanedData.party_hosts.length;
          }
        }
        
        log('', 'info');
        log(`‚ú® Cleanup complete! Deleted ${deleted} orphaned records.`, 'success');
        log('', 'info');
        log('üí° Run scan again to verify cleanup was successful.', 'info');
        
        // Reset state
        window.orphanedData = null;
        cleanupBtn.disabled = true;
        
      } catch (error) {
        log(`‚ùå Unexpected error: ${error.message}`, 'error');
        console.error(error);
      }
      
      scanBtn.disabled = false;
    };
  </script>
</body>
</html>
