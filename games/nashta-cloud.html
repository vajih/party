<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nashta Cloud ‚Äî Party Game</title>
  <style>
    :root{
      --bg:#0c0c0f;
      --fg:#f4f4f7;
      --muted:#9aa0a6;
      --accent:#ffd166;
      --accent2:#06d6a0;
      --danger:#ef476f;
      --shadow: rgba(0,0,0,.35);
      /* Dilwale brand colors */
      --brand-red:#dc2626;
      --brand-gold:#fbbf24;
      --brand-orange:#f97316;
      /* Nashta category colors */
      --paratha-color:#f472b6;
      --puri-color:#fbbf24;
      --nihari-color:#dc2626;
      --anda-color:#fb923c;
      --cereal-color:#60a5fa;
      --other-color:#a78bfa;
    }
    html,body{
      height:100%;
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:20px;
      padding:20px;
    }
    .controls{
      width:100%; max-width:1200px;
      display:flex; align-items:center; justify-content:center;
      gap:12px; flex-wrap:wrap;
    }
    button{
      background:#17171c; color:var(--fg); border:1px solid #2a2a31;
      padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow: 0 6px 20px var(--shadow);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); border-color:#3a3a44; }
    button:active{ transform: translateY(0); }
    button.active{
      background: linear-gradient(135deg, var(--brand-red), var(--brand-orange));
      border-color: var(--brand-gold);
    }
    .stage{
      position:relative; width:100%; max-width:1200px; height:80vh;
      flex:1 1 auto; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 50% 30%, #16161b, #0e0e12 70%, #0b0b0e 90%);
      border:4px solid transparent;
      border-image: linear-gradient(135deg, var(--brand-red), var(--brand-orange), var(--brand-gold)) 1;
      border-radius:20px;
      overflow:hidden;
      box-shadow: 
        0 24px 60px var(--shadow),
        0 0 0 1px rgba(220, 38, 38, 0.3),
        inset 0 0 40px rgba(220, 38, 38, 0.05);
    }
    .logo-frame{
      position:absolute;
      bottom:12px;
      left:12px;
      z-index:10;
      opacity:0.4;
      transition: opacity 0.3s ease;
    }
    .logo-frame:hover{
      opacity:0.7;
    }
    .logo-frame img{
      height:32px;
      width:auto;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));
    }
    .cloud-container{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      padding:40px;
      position:relative;
    }
    .word-cloud{
      width:100%; height:100%;
      display:flex; flex-wrap:wrap; align-items:center; justify-content:center;
      gap:20px;
      position:relative;
    }
    .nashta-word{
      display:inline-block;
      padding:8px 16px;
      margin:4px;
      cursor:pointer;
      transition: transform 0.3s ease, opacity 0.3s ease;
      font-weight:700;
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
      border-radius:8px;
      background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      backdrop-filter: blur(4px);
    }
    .nashta-word:hover{
      transform: scale(1.15);
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    .nashta-word.hidden{
      opacity:0.2;
      transform: scale(0.9);
    }
    .stats-overlay{
      position:absolute;
      top:20px;
      right:20px;
      background: linear-gradient(135deg, rgba(0,0,0,.85), rgba(0,0,0,.7));
      backdrop-filter: blur(10px);
      padding:16px 24px;
      border-radius:12px;
      border:2px solid rgba(220, 38, 38, 0.4);
      box-shadow: 0 8px 24px rgba(0,0,0,.6);
      text-align:right;
    }
    .stats-overlay h3{
      margin:0 0 8px 0;
      font-size:1rem;
      color:var(--muted);
      font-weight:600;
    }
    .stats-overlay .big-number{
      font-size:2.5rem;
      font-weight:900;
      background: linear-gradient(135deg, var(--brand-red), var(--brand-orange), var(--brand-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin:0;
    }
    .loading-overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(12,12,15,0.95); z-index:100; flex-direction:column; gap:16px;
    }
    .spinner{
      width:40px; height:40px; border:3px solid #2a2a31;
      border-top-color:var(--brand-red); border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .legend{
      display:flex; gap:20px; align-items:center; justify-content:center;
      font-size:0.9rem;
      flex-wrap:wrap;
    }
    .legend-item{
      display:flex; align-items:center; gap:8px;
    }
    .legend-dot{
      width:12px; height:12px; border-radius:50%;
    }
    .tooltip{
      position:fixed;
      background: rgba(0,0,0,0.9);
      color:var(--fg);
      padding:8px 12px;
      border-radius:6px;
      font-size:0.85rem;
      pointer-events:none;
      z-index:1000;
      opacity:0;
      transition:opacity 0.2s ease;
      border:1px solid rgba(255,255,255,0.2);
      max-width:300px;
    }
    .tooltip.show{ opacity:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <button id="allBtn" class="active">All Nashta</button>
      <button id="parathaBtn">Paratha + Chai</button>
      <button id="puriBtn">Puri (Halwa/Aloo)</button>
      <button id="nihariBtn">Nihari + Naan</button>
      <button id="andaBtn">Anda Paratha</button>
      <button id="cerealBtn">Cereal</button>
      <button id="otherBtn">Other</button>
      <button id="refreshBtn">üîÑ Refresh</button>
    </div>

    <div class="stage" id="stage">
      <div class="logo-frame">
        <img src="../assets/img/dilwale_logo.png" alt="Dilwale Logo" />
      </div>
      
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color:var(--muted); font-weight:600;">Loading nashta preferences...</div>
      </div>

      <div class="stats-overlay">
        <h3>Unique Nashta</h3>
        <p class="big-number" id="nashtaCount">0</p>
      </div>

      <div class="cloud-container">
        <div class="word-cloud" id="wordCloud"></div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--paratha-color);"></div>
        <span>Paratha + Chai</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--puri-color);"></div>
        <span>Puri (Halwa/Aloo)</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--nihari-color);"></div>
        <span>Nihari + Naan</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--anda-color);"></div>
        <span>Anda Paratha</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--cereal-color);"></div>
        <span>Cereal</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--other-color);"></div>
        <span>Other</span>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config/env.local.js"></script>

  <script>
    // ======== VERIFY CONFIG LOADED ========
    if (typeof CONFIG === 'undefined') {
      console.error('‚ùå CONFIG not loaded! Check if config/env.local.js exists');
      document.getElementById('loadingOverlay').innerHTML = `
        <div style="color:var(--danger); font-weight:600;">Configuration Error</div>
        <div style="color:var(--muted); font-size:0.9rem;">config/env.local.js not found</div>
      `;
      throw new Error('CONFIG is undefined');
    }
    
    console.log('‚úÖ Config loaded');
    
    // ======== SUPABASE SETUP ========
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase client initialized');
    
    // ======== DATA STRUCTURES ========
    let nashtaData = [];
    let currentFilter = 'all';
    
    // Nashta normalization map - handle common variations/typos
    const nashtaNormalization = {
      // Paratha variations
      'paratha chai': 'Paratha + Chai',
      'paratha and chai': 'Paratha + Chai',
      'paratha with chai': 'Paratha + Chai',
      'paratha': 'Paratha + Chai',
      'chai paratha': 'Paratha + Chai',
      'parathas': 'Paratha + Chai',
      
      // Halwa Puri variations
      'halwa puri': 'Halwa Puri',
      'halwa poori': 'Halwa Puri',
      'puri halwa': 'Halwa Puri',
      'poori halwa': 'Halwa Puri',
      'halwa': 'Halwa Puri',
      'puri': 'Halwa Puri',
      'poori': 'Halwa Puri',
      
      // Aloo Puri variations
      'aloo puri': 'Aloo Puri',
      'aloo poori': 'Aloo Puri',
      'puri aloo': 'Aloo Puri',
      'poori aloo': 'Aloo Puri',
      'aalu puri': 'Aloo Puri',
      'aalu poori': 'Aloo Puri',
      
      // Nihari variations
      'nihari naan': 'Nihari + Naan',
      'nihari and naan': 'Nihari + Naan',
      'nihari with naan': 'Nihari + Naan',
      'nihari': 'Nihari + Naan',
      'naan nihari': 'Nihari + Naan',
      'nihari paratha': 'Nihari + Paratha',
      'nihari and paratha': 'Nihari + Paratha',
      
      // Anda Paratha variations
      'anda paratha': 'Anda Paratha',
      'egg paratha': 'Anda Paratha',
      'paratha anda': 'Anda Paratha',
      'anday wala paratha': 'Anda Paratha',
      'ande ka paratha': 'Anda Paratha',
      
      // Cereal variations
      'cereal': 'Cereal',
      'cereals': 'Cereal',
      'corn flakes': 'Cereal',
      'cornflakes': 'Cereal',
      'breakfast cereal': 'Cereal',
      
      // Other desi breakfast items
      'channay': 'Channay',
      'chana': 'Channay',
      'chole': 'Channay',
      'paye': 'Paye',
      'paaye': 'Paye',
      'siri paye': 'Paye',
      'lassi': 'Lassi',
      'doodh patti': 'Doodh Patti',
      'chai': 'Chai',
      'nashta': 'Mixed Nashta',
    };
    
    // Nashta category mapping
    const nashtaCategory = {
      'paratha + chai': 'paratha',
      'paratha': 'paratha',
      'halwa puri': 'puri',
      'aloo puri': 'puri',
      'aloo poori': 'puri',
      'nihari + naan': 'nihari',
      'nihari + paratha': 'nihari',
      'anda paratha': 'anda',
      'egg paratha': 'anda',
      'cereal': 'cereal',
      'corn flakes': 'cereal',
      'channay': 'other',
      'paye': 'other',
      'lassi': 'other',
      'doodh patti': 'other',
      'chai': 'other',
      'mixed nashta': 'other',
    };
    
    // ======== LOAD DATA FROM SUPABASE ========
    async function loadNashtaData() {
      try {
        const PARTY_SLUG = 'friendsgiving2025-1ty7';
        
        console.log('üîç Loading nashta data...');
        
        // Get party ID
        const { data: party, error: partyError } = await supabaseClient
          .from('parties')
          .select('id')
          .eq('slug', PARTY_SLUG)
          .single();
        
        if (partyError) throw partyError;
        console.log('‚úÖ Party found:', party.id);
        
        // Get all profiles with extended_answers
        const { data: profiles, error: profileError } = await supabaseClient
          .from('party_profiles')
          .select('user_id, display_name, extended_answers')
          .eq('party_id', party.id);
        
        if (profileError) throw profileError;
        console.log(`‚úÖ Found ${profiles.length} profiles`);
        
        // Extract and count nashta with normalization
        const nashtaCount = {};
        
        profiles.forEach(profile => {
          let nashta = profile.extended_answers?.breakfast_nashta;
          
          // Check if this is a write-in custom entry (format: X:other:Custom Name)
          if (nashta && nashta.startsWith('X:')) {
            const parts = nashta.split(':');
            if (parts.length >= 3) {
              // Extract the custom nashta name after "X:other:"
              nashta = parts.slice(2).join(':').trim();
              console.log(`üìù Found custom nashta: "${nashta}"`);
            }
          }
          
          if (nashta && nashta.trim() && nashta.toLowerCase() !== 'not shared' && nashta.toLowerCase() !== 'other') {
            // Apply smart normalization
            const normalizedNashta = normalizeNashtaName(nashta);
            
            if (!nashtaCount[normalizedNashta]) {
              nashtaCount[normalizedNashta] = {
                name: normalizedNashta,
                count: 0,
                category: detectCategory(normalizedNashta),
                guests: [],
                originalInputs: [] // Track what people actually typed
              };
            }
            nashtaCount[normalizedNashta].count++;
            nashtaCount[normalizedNashta].guests.push(profile.display_name);
            nashtaCount[normalizedNashta].originalInputs.push(nashta.trim());
          }
        });
        
        // Convert to array and sort by count
        nashtaData = Object.values(nashtaCount).sort((a, b) => b.count - a.count);
        
        console.log(`‚úÖ Found ${nashtaData.length} unique nashta items`);
        console.log('Top nashta:', nashtaData.slice(0, 5));
        
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('nashtaCount').textContent = nashtaData.length;
        
        renderWordCloud();
        
      } catch (error) {
        console.error('Error loading nashta data:', error);
        document.getElementById('loadingOverlay').innerHTML = `
          <div style="color:var(--danger); font-weight:600;">Failed to load data</div>
          <div style="color:var(--muted); font-size:0.9rem;">Check console for details</div>
        `;
      }
    }
    
    // ======== NORMALIZE NASHTA NAME ========
    function normalizeNashtaName(rawName) {
      if (!rawName) return '';
      
      // Step 1: Basic cleanup
      let cleaned = rawName.trim();
      
      // Step 2: Remove common filler words and punctuation cleanup
      cleaned = cleaned
        .replace(/[!?.,;]/g, '') // Remove punctuation
        .replace(/\s+/g, ' ') // Normalize whitespace
        .replace(/\s*\+\s*/g, ' + ') // Normalize plus signs
        .trim();
      
      // Step 3: Check against normalization map (case-insensitive)
      const lowerCleaned = cleaned.toLowerCase();
      if (nashtaNormalization[lowerCleaned]) {
        console.log(`üîÑ Normalized "${rawName}" ‚Üí "${nashtaNormalization[lowerCleaned]}"`);
        return nashtaNormalization[lowerCleaned];
      }
      
      // Step 4: Title case for consistent formatting
      const titleCased = cleaned
        .split(' ')
        .map(word => {
          // Keep connecting words lowercase
          if (['+', 'and', 'with', 'the', 'ka', 'ki', 'ke', 'wala', 'wali'].includes(word.toLowerCase())) {
            return word === '+' ? '+' : word.toLowerCase();
          }
          // Title case regular words
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        })
        .join(' ');
      
      // Step 5: Check if title-cased version matches normalization map
      const lowerTitled = titleCased.toLowerCase();
      if (nashtaNormalization[lowerTitled]) {
        console.log(`üîÑ Normalized "${rawName}" ‚Üí "${nashtaNormalization[lowerTitled]}"`);
        return nashtaNormalization[lowerTitled];
      }
      
      console.log(`‚ú® Using cleaned name: "${rawName}" ‚Üí "${titleCased}"`);
      return titleCased;
    }
    
    // ======== DETECT CATEGORY FROM NASHTA ========
    function detectCategory(nashtaName) {
      const normalized = nashtaName.toLowerCase().trim();
      
      // Check exact matches first
      if (nashtaCategory[normalized]) {
        return nashtaCategory[normalized];
      }
      
      // Keyword-based detection
      if (normalized.includes('paratha') && normalized.includes('chai')) {
        return 'paratha';
      }
      if (normalized.includes('paratha') && normalized.includes('anda')) {
        return 'anda';
      }
      if (normalized.includes('paratha') && normalized.includes('egg')) {
        return 'anda';
      }
      if (normalized.includes('halwa') || normalized.includes('aloo') && normalized.includes('puri')) {
        return 'puri';
      }
      if (normalized.includes('nihari')) {
        return 'nihari';
      }
      if (normalized.includes('cereal') || normalized.includes('corn flakes')) {
        return 'cereal';
      }
      if (normalized.includes('paratha') && !normalized.includes('anda')) {
        return 'paratha';
      }
      
      return 'other';
    }
    
    // ======== GET COLOR BY CATEGORY ========
    function getCategoryColor(category) {
      const colorMap = {
        'paratha': 'var(--paratha-color)',
        'puri': 'var(--puri-color)',
        'nihari': 'var(--nihari-color)',
        'anda': 'var(--anda-color)',
        'cereal': 'var(--cereal-color)',
        'other': 'var(--other-color)'
      };
      return colorMap[category] || colorMap['other'];
    }
    
    // ======== RENDER WORD CLOUD ========
    function renderWordCloud() {
      const container = document.getElementById('wordCloud');
      container.innerHTML = '';
      
      // Filter data based on current filter
      const filteredData = nashtaData.filter(nashta => {
        if (currentFilter === 'all') return true;
        return nashta.category === currentFilter;
      });
      
      if (filteredData.length === 0) {
        container.innerHTML = '<div style="color:var(--muted); font-size:1.5rem;">No nashta found for this filter</div>';
        return;
      }
      
      // Calculate font sizes (min 1rem, max 5rem based on count)
      const maxCount = Math.max(...filteredData.map(n => n.count));
      const minCount = Math.min(...filteredData.map(n => n.count));
      
      filteredData.forEach(nashta => {
        const word = document.createElement('div');
        word.className = 'nashta-word';
        word.textContent = nashta.name;
        
        // Calculate font size (logarithmic scale for better distribution)
        const ratio = maxCount === minCount ? 1 : (Math.log(nashta.count) - Math.log(minCount)) / (Math.log(maxCount) - Math.log(minCount));
        const fontSize = 1 + (ratio * 4); // 1rem to 5rem
        word.style.fontSize = `${fontSize}rem`;
        
        // Apply color based on category
        word.style.color = getCategoryColor(nashta.category);
        
        // Add hover tooltip
        word.addEventListener('mouseenter', (e) => showTooltip(e, nashta));
        word.addEventListener('mouseleave', hideTooltip);
        word.addEventListener('mousemove', moveTooltip);
        
        container.appendChild(word);
      });
      
      // Shuffle positions for more organic look
      const words = Array.from(container.children);
      words.sort(() => Math.random() - 0.5);
      words.forEach(word => container.appendChild(word));
    }
    
    // ======== TOOLTIP FUNCTIONS ========
    const tooltip = document.getElementById('tooltip');
    
    function showTooltip(e, nashta) {
      const guestList = nashta.guests.join(', ');
      
      // Show original inputs if there were variations normalized
      const uniqueInputs = [...new Set(nashta.originalInputs)];
      const variationsText = uniqueInputs.length > 1 
        ? `<br><small style="color:var(--muted); font-style:italic;">Variations: ${uniqueInputs.join(', ')}</small>`
        : '';
      
      const categoryName = {
        'paratha': 'Paratha + Chai',
        'puri': 'Puri (Halwa/Aloo)',
        'nihari': 'Nihari + Naan',
        'anda': 'Anda Paratha',
        'cereal': 'Cereal',
        'other': 'Other'
      }[nashta.category] || 'Other';
      
      tooltip.innerHTML = `
        <strong>${nashta.name}</strong> <span style="color:${getCategoryColor(nashta.category)};">‚óè ${categoryName}</span><br>
        ${nashta.count} ${nashta.count === 1 ? 'person' : 'people'}<br>
        <small style="color:var(--muted);">${guestList}</small>
        ${variationsText}
      `;
      tooltip.classList.add('show');
      moveTooltip(e);
    }
    
    function hideTooltip() {
      tooltip.classList.remove('show');
    }
    
    function moveTooltip(e) {
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
    }
    
    // ======== FILTER CONTROLS ========
    document.getElementById('allBtn').addEventListener('click', () => {
      currentFilter = 'all';
      updateActiveButton('allBtn');
      renderWordCloud();
    });
    
    document.getElementById('parathaBtn').addEventListener('click', () => {
      currentFilter = 'paratha';
      updateActiveButton('parathaBtn');
      renderWordCloud();
    });
    
    document.getElementById('puriBtn').addEventListener('click', () => {
      currentFilter = 'puri';
      updateActiveButton('puriBtn');
      renderWordCloud();
    });
    
    document.getElementById('nihariBtn').addEventListener('click', () => {
      currentFilter = 'nihari';
      updateActiveButton('nihariBtn');
      renderWordCloud();
    });
    
    document.getElementById('andaBtn').addEventListener('click', () => {
      currentFilter = 'anda';
      updateActiveButton('andaBtn');
      renderWordCloud();
    });
    
    document.getElementById('cerealBtn').addEventListener('click', () => {
      currentFilter = 'cereal';
      updateActiveButton('cerealBtn');
      renderWordCloud();
    });
    
    document.getElementById('otherBtn').addEventListener('click', () => {
      currentFilter = 'other';
      updateActiveButton('otherBtn');
      renderWordCloud();
    });
    
    document.getElementById('refreshBtn').addEventListener('click', () => {
      document.getElementById('loadingOverlay').style.display = 'flex';
      loadNashtaData();
    });
    
    function updateActiveButton(activeId) {
      ['allBtn', 'parathaBtn', 'puriBtn', 'nihariBtn', 'andaBtn', 'cerealBtn', 'otherBtn'].forEach(id => {
        document.getElementById(id).classList.toggle('active', id === activeId);
      });
    }
    
    // ======== INITIALIZE ========
    loadNashtaData();
  </script>
</body>
</html>
