<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Celebrity Crush Cloud ‚Äî Party Game</title>
  <style>
    :root{
      --bg:#0c0c0f;
      --fg:#f4f4f7;
      --muted:#9aa0a6;
      --accent:#ffd166;
      --accent2:#06d6a0;
      --danger:#ef476f;
      --shadow: rgba(0,0,0,.35);
      /* Dilwale brand colors */
      --brand-red:#dc2626;
      --brand-gold:#fbbf24;
      --brand-orange:#f97316;
      /* Gender colors for word cloud */
      --male-crush:#60a5fa;
      --female-crush:#f472b6;
      --neutral-crush:#a78bfa;
    }
    html,body{
      height:100%;
      margin:0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:20px;
      padding:20px;
    }
    .controls{
      width:100%; max-width:1200px;
      display:flex; align-items:center; justify-content:center;
      gap:12px; flex-wrap:wrap;
    }
    button{
      background:#17171c; color:var(--fg); border:1px solid #2a2a31;
      padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:600;
      box-shadow: 0 6px 20px var(--shadow);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); border-color:#3a3a44; }
    button:active{ transform: translateY(0); }
    button.active{
      background: linear-gradient(135deg, var(--brand-red), var(--brand-orange));
      border-color: var(--brand-gold);
    }
    .stage{
      position:relative; width:100%; max-width:1200px; height:80vh;
      flex:1 1 auto; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 50% 30%, #16161b, #0e0e12 70%, #0b0b0e 90%);
      border:4px solid transparent;
      border-image: linear-gradient(135deg, var(--brand-red), var(--brand-orange), var(--brand-gold)) 1;
      border-radius:20px;
      overflow:hidden;
      box-shadow: 
        0 24px 60px var(--shadow),
        0 0 0 1px rgba(220, 38, 38, 0.3),
        inset 0 0 40px rgba(220, 38, 38, 0.05);
    }
    .logo-frame{
      position:absolute;
      bottom:12px;
      left:12px;
      z-index:10;
      opacity:0.4;
      transition: opacity 0.3s ease;
    }
    .logo-frame:hover{
      opacity:0.7;
    }
    .logo-frame img{
      height:32px;
      width:auto;
      display:block;
      filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));
    }
    .cloud-container{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      padding:40px;
      position:relative;
    }
    .word-cloud{
      width:100%; height:100%;
      display:flex; flex-wrap:wrap; align-items:center; justify-content:center;
      gap:20px;
      position:relative;
    }
    .crush-word{
      display:inline-block;
      padding:8px 16px;
      margin:4px;
      cursor:pointer;
      transition: transform 0.3s ease, opacity 0.3s ease;
      font-weight:700;
      text-shadow: 0 2px 8px rgba(0,0,0,0.6);
      border-radius:8px;
      background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      backdrop-filter: blur(4px);
    }
    .crush-word:hover{
      transform: scale(1.15);
      background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    .crush-word.hidden{
      opacity:0.2;
      transform: scale(0.9);
    }
    .stats-overlay{
      position:absolute;
      top:20px;
      right:20px;
      background: linear-gradient(135deg, rgba(0,0,0,.85), rgba(0,0,0,.7));
      backdrop-filter: blur(10px);
      padding:16px 24px;
      border-radius:12px;
      border:2px solid rgba(220, 38, 38, 0.4);
      box-shadow: 0 8px 24px rgba(0,0,0,.6);
      text-align:right;
    }
    .stats-overlay h3{
      margin:0 0 8px 0;
      font-size:1rem;
      color:var(--muted);
      font-weight:600;
    }
    .stats-overlay .big-number{
      font-size:2.5rem;
      font-weight:900;
      background: linear-gradient(135deg, var(--brand-red), var(--brand-orange), var(--brand-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin:0;
    }
    .loading-overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(12,12,15,0.95); z-index:100; flex-direction:column; gap:16px;
    }
    .spinner{
      width:40px; height:40px; border:3px solid #2a2a31;
      border-top-color:var(--brand-red); border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .legend{
      display:flex; gap:20px; align-items:center; justify-content:center;
      font-size:0.9rem;
    }
    .legend-item{
      display:flex; align-items:center; gap:8px;
    }
    .legend-dot{
      width:12px; height:12px; border-radius:50%;
    }
    .tooltip{
      position:fixed;
      background: rgba(0,0,0,0.9);
      color:var(--fg);
      padding:8px 12px;
      border-radius:6px;
      font-size:0.85rem;
      pointer-events:none;
      z-index:1000;
      opacity:0;
      transition:opacity 0.2s ease;
      border:1px solid rgba(255,255,255,0.2);
    }
    .tooltip.show{ opacity:1; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="controls">
      <button id="allBtn" class="active">All Crushes</button>
      <button id="maleBtn">Male Celebrities</button>
      <button id="femaleBtn">Female Celebrities</button>
      <button id="refreshBtn">üîÑ Refresh</button>
    </div>

    <div class="stage" id="stage">
      <div class="logo-frame">
        <img src="../assets/img/dilwale_logo.png" alt="Dilwale Logo" />
      </div>
      
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color:var(--muted); font-weight:600;">Loading celebrity crushes...</div>
      </div>

      <div class="stats-overlay">
        <h3>Unique Crushes</h3>
        <p class="big-number" id="crushCount">0</p>
      </div>

      <div class="cloud-container">
        <div class="word-cloud" id="wordCloud"></div>
      </div>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--male-crush);"></div>
        <span>Male Celebrity</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--female-crush);"></div>
        <span>Female Celebrity</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background:var(--neutral-crush);"></div>
        <span>Unknown/Other</span>
      </div>
    </div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config/env.local.js"></script>

  <script>
    // ======== VERIFY CONFIG LOADED ========
    if (typeof CONFIG === 'undefined') {
      console.error('‚ùå CONFIG not loaded! Check if config/env.local.js exists');
      document.getElementById('loadingOverlay').innerHTML = `
        <div style="color:var(--danger); font-weight:600;">Configuration Error</div>
        <div style="color:var(--muted); font-size:0.9rem;">config/env.local.js not found</div>
      `;
      throw new Error('CONFIG is undefined');
    }
    
    console.log('‚úÖ Config loaded');
    
    // ======== SUPABASE SETUP ========
    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase client initialized');
    
    // ======== DATA STRUCTURES ========
    let crushData = [];
    let currentFilter = 'all';
    
    // Name normalization map - maps variations to canonical names
    const nameNormalization = {
      // Shah Rukh Khan variations
      'srk': 'Shah Rukh Khan',
      'shahrukh khan': 'Shah Rukh Khan',
      'sharukh khan': 'Shah Rukh Khan',
      'shah rukh': 'Shah Rukh Khan',
      'shahrukh': 'Shah Rukh Khan',
      
      // Salman Khan variations
      'sallu': 'Salman Khan',
      'bhai': 'Salman Khan',
      
      // Hrithik Roshan variations
      'hrithik': 'Hrithik Roshan',
      'ritik roshan': 'Hrithik Roshan',
      
      // Leonardo DiCaprio variations
      'leo dicaprio': 'Leonardo DiCaprio',
      'leonardo': 'Leonardo DiCaprio',
      'dicaprio': 'Leonardo DiCaprio',
      
      // Brad Pitt variations
      'brad': 'Brad Pitt',
      
      // Tom Cruise variations
      'tom': 'Tom Cruise',
      
      // Zendaya variations
      'zendaya coleman': 'Zendaya',
      
      // Taylor Swift variations
      'taylor': 'Taylor Swift',
      'tswift': 'Taylor Swift',
      
      // Add more variations as you discover them
    };
    
    // Known celebrity gender mapping (extensible)
    const celebrityGender = {
      // Male celebrities
      'shah rukh khan': 'male', 'salman khan': 'male', 'aamir khan': 'male', 
      'hrithik roshan': 'male', 'ranbir kapoor': 'male', 'ranveer singh': 'male',
      'tom cruise': 'male', 'brad pitt': 'male', 'leonardo dicaprio': 'male',
      'will smith': 'male', 'johnny depp': 'male', 'robert downey jr': 'male',
      'chris hemsworth': 'male', 'chris evans': 'male', 'ryan gosling': 'male',
      'zayn malik': 'male', 'harry styles': 'male', 'shawn mendes': 'male',
      'drake': 'male', 'the weeknd': 'male', 'michael b jordan': 'male',
      'timothee chalamet': 'male', 'tom holland': 'male', 'zac efron': 'male',
      'henry cavill': 'male', 'idris elba': 'male', 'keanu reeves': 'male',
      
      // Female celebrities
      'aishwarya rai': 'female', 'priyanka chopra': 'female', 'deepika padukone': 'female',
      'katrina kaif': 'female', 'kareena kapoor': 'female', 'alia bhatt': 'female',
      'angelina jolie': 'female', 'jennifer aniston': 'female', 'scarlett johansson': 'female',
      'emma watson': 'female', 'emma stone': 'female', 'margot robbie': 'female',
      'taylor swift': 'female', 'beyonce': 'female', 'rihanna': 'female',
      'ariana grande': 'female', 'selena gomez': 'female', 'billie eilish': 'female',
      'zendaya': 'female', 'florence pugh': 'female', 'anya taylor-joy': 'female'
    };
    
    // ======== LOAD DATA FROM SUPABASE ========
    async function loadCrushData() {
      try {
        const PARTY_SLUG = 'friendsgiving2025-1ty7';
        
        console.log('üîç Loading celebrity crush data...');
        
        // Get party ID
        const { data: party, error: partyError } = await supabaseClient
          .from('parties')
          .select('id')
          .eq('slug', PARTY_SLUG)
          .single();
        
        if (partyError) throw partyError;
        console.log('‚úÖ Party found:', party.id);
        
        // Get all profiles with extended_answers
        const { data: profiles, error: profileError } = await supabaseClient
          .from('party_profiles')
          .select('user_id, display_name, extended_answers')
          .eq('party_id', party.id);
        
        if (profileError) throw profileError;
        console.log(`‚úÖ Found ${profiles.length} profiles`);
        
        // Extract and count crushes with normalization
        const crushCount = {};
        
        profiles.forEach(profile => {
          let crush = profile.extended_answers?.celebrity_crush_teen;
          
          // Check if this is a write-in custom entry (format: X:other:Custom Name)
          if (crush && crush.startsWith('X:')) {
            const parts = crush.split(':');
            if (parts.length >= 3) {
              // Extract the custom celebrity name after "X:other:"
              crush = parts.slice(2).join(':').trim();
              console.log(`üìù Found custom celebrity: "${crush}"`);
            }
          }
          
          if (crush && crush.trim() && crush.toLowerCase() !== 'not shared') {
            // Apply smart normalization
            const normalizedCrush = normalizeCrushName(crush);
            
            if (!crushCount[normalizedCrush]) {
              crushCount[normalizedCrush] = {
                name: normalizedCrush,
                count: 0,
                gender: detectGender(normalizedCrush),
                guests: [],
                originalInputs: [] // Track what people actually typed
              };
            }
            crushCount[normalizedCrush].count++;
            crushCount[normalizedCrush].guests.push(profile.display_name);
            crushCount[normalizedCrush].originalInputs.push(crush.trim());
          }
        });
        
        // Convert to array and sort by count
        crushData = Object.values(crushCount).sort((a, b) => b.count - a.count);
        
        console.log(`‚úÖ Found ${crushData.length} unique crushes`);
        console.log('Top crushes:', crushData.slice(0, 5));
        
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('crushCount').textContent = crushData.length;
        
        renderWordCloud();
        
      } catch (error) {
        console.error('Error loading crush data:', error);
        document.getElementById('loadingOverlay').innerHTML = `
          <div style="color:var(--danger); font-weight:600;">Failed to load data</div>
          <div style="color:var(--muted); font-size:0.9rem;">Check console for details</div>
        `;
      }
    }
    
    // ======== NORMALIZE CRUSH NAME ========
    function normalizeCrushName(rawName) {
      if (!rawName) return '';
      
      // Step 1: Basic cleanup
      let cleaned = rawName.trim();
      
      // Step 2: Remove common filler words and punctuation
      cleaned = cleaned
        .replace(/[!?.,;:]/g, '') // Remove punctuation
        .replace(/\s+/g, ' ') // Normalize whitespace
        .trim();
      
      // Step 3: Check against normalization map (case-insensitive)
      const lowerCleaned = cleaned.toLowerCase();
      if (nameNormalization[lowerCleaned]) {
        console.log(`üîÑ Normalized "${rawName}" ‚Üí "${nameNormalization[lowerCleaned]}"`);
        return nameNormalization[lowerCleaned];
      }
      
      // Step 4: Title case for consistent formatting
      const titleCased = cleaned
        .split(' ')
        .map(word => {
          // Keep all caps words (like "SRK") as-is
          if (word === word.toUpperCase() && word.length <= 3) {
            return word;
          }
          // Title case regular words
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        })
        .join(' ');
      
      // Step 5: Check if title-cased version matches normalization map
      const lowerTitled = titleCased.toLowerCase();
      if (nameNormalization[lowerTitled]) {
        console.log(`üîÑ Normalized "${rawName}" ‚Üí "${nameNormalization[lowerTitled]}"`);
        return nameNormalization[lowerTitled];
      }
      
      console.log(`‚ú® Using cleaned name: "${rawName}" ‚Üí "${titleCased}"`);
      return titleCased;
    }
    
    // ======== DETECT GENDER FROM NAME ========
    function detectGender(crushName) {
      const normalized = crushName.toLowerCase().trim();
      
      // Check exact matches first
      if (celebrityGender[normalized]) {
        return celebrityGender[normalized];
      }
      
      // Check partial matches
      for (const [celebrity, gender] of Object.entries(celebrityGender)) {
        if (normalized.includes(celebrity) || celebrity.includes(normalized)) {
          return gender;
        }
      }
      
      return 'neutral';
    }
    
    // ======== RENDER WORD CLOUD ========
    function renderWordCloud() {
      const container = document.getElementById('wordCloud');
      container.innerHTML = '';
      
      // Filter data based on current filter
      const filteredData = crushData.filter(crush => {
        if (currentFilter === 'all') return true;
        return crush.gender === currentFilter;
      });
      
      if (filteredData.length === 0) {
        container.innerHTML = '<div style="color:var(--muted); font-size:1.5rem;">No crushes found for this filter</div>';
        return;
      }
      
      // Calculate font sizes (min 1rem, max 5rem based on count)
      const maxCount = Math.max(...filteredData.map(c => c.count));
      const minCount = Math.min(...filteredData.map(c => c.count));
      
      filteredData.forEach(crush => {
        const word = document.createElement('div');
        word.className = 'crush-word';
        word.textContent = crush.name;
        
        // Calculate font size (logarithmic scale for better distribution)
        const ratio = maxCount === minCount ? 1 : (Math.log(crush.count) - Math.log(minCount)) / (Math.log(maxCount) - Math.log(minCount));
        const fontSize = 1 + (ratio * 4); // 1rem to 5rem
        word.style.fontSize = `${fontSize}rem`;
        
        // Apply color based on gender
        if (crush.gender === 'male') {
          word.style.color = 'var(--male-crush)';
        } else if (crush.gender === 'female') {
          word.style.color = 'var(--female-crush)';
        } else {
          word.style.color = 'var(--neutral-crush)';
        }
        
        // Add hover tooltip
        word.addEventListener('mouseenter', (e) => showTooltip(e, crush));
        word.addEventListener('mouseleave', hideTooltip);
        word.addEventListener('mousemove', moveTooltip);
        
        container.appendChild(word);
      });
      
      // Shuffle positions for more organic look
      const words = Array.from(container.children);
      words.sort(() => Math.random() - 0.5);
      words.forEach(word => container.appendChild(word));
    }
    
    // ======== TOOLTIP FUNCTIONS ========
    const tooltip = document.getElementById('tooltip');
    
    function showTooltip(e, crush) {
      const guestList = crush.guests.join(', ');
      
      // Show original inputs if there were variations normalized
      const uniqueInputs = [...new Set(crush.originalInputs)];
      const variationsText = uniqueInputs.length > 1 
        ? `<br><small style="color:var(--muted); font-style:italic;">Variations: ${uniqueInputs.join(', ')}</small>`
        : '';
      
      tooltip.innerHTML = `
        <strong>${crush.name}</strong><br>
        ${crush.count} ${crush.count === 1 ? 'person' : 'people'}<br>
        <small style="color:var(--muted);">${guestList}</small>
        ${variationsText}
      `;
      tooltip.classList.add('show');
      moveTooltip(e);
    }
    
    function hideTooltip() {
      tooltip.classList.remove('show');
    }
    
    function moveTooltip(e) {
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
    }
    
    // ======== FILTER CONTROLS ========
    document.getElementById('allBtn').addEventListener('click', () => {
      currentFilter = 'all';
      updateActiveButton('allBtn');
      renderWordCloud();
    });
    
    document.getElementById('maleBtn').addEventListener('click', () => {
      currentFilter = 'male';
      updateActiveButton('maleBtn');
      renderWordCloud();
    });
    
    document.getElementById('femaleBtn').addEventListener('click', () => {
      currentFilter = 'female';
      updateActiveButton('femaleBtn');
      renderWordCloud();
    });
    
    document.getElementById('refreshBtn').addEventListener('click', () => {
      document.getElementById('loadingOverlay').style.display = 'flex';
      loadCrushData();
    });
    
    function updateActiveButton(activeId) {
      ['allBtn', 'maleBtn', 'femaleBtn'].forEach(id => {
        document.getElementById(id).classList.toggle('active', id === activeId);
      });
    }
    
    // ======== INITIALIZE ========
    loadCrushData();
  </script>
</body>
</html>
